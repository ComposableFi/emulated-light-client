# Program Implementing Cross-Chain Calls Based on ICS27 Specification

This document outlines the operation of a program designed to facilitate cross-chain calls in adherence to the ICS27 specification. The program enables the execution of cross-chain transactions, leveraging the Inter-Blockchain Communication (IBC) protocol for secure and verified interactions between different blockchain networks.

## Workflow:

### 1. Relayer Interaction:


A Relayer sends full IBC packet(header+data) into `simulate` instruction into contract.

Contract outputs all accounts it needs for execution as **Anchor compatible event**.

Simulate method can output more arbitrary logs and evnets, relayer ignores them.

Simulate method can fail TX, but as long as log was output relayer should try relay with these accounts.

Extend lookup table can be output several times during simulation, relayer should use all of them.

```json
// naming used to adhere that event is command for next step in flow
{ 
"ExtendLookupTable" : { 
  new_addresses: ["pubkey1", .., "pubkeyN"] 
}
```

A Relayer invokes the `deliver` function on the program, passing in packet data and accounts for processing.

### 2. Packet Verification:

The program verifies that the packet has been authenticated by the IBC core program's account, ensuring its legitimacy.

### 3. Packet Parsing and Account Verification:

It parses the packet according to the `svm/borsh-1` standard, ensuring the packet data is correctly serialized/deserialized.
Verifies that the accounts specified by the relayer match those included in the packet, ensuring consistency and authenticity.

### 4. Execution of Cross-Chain Transaction:

Executes the transaction detailed in the packet, adhering to all specifications and requirements mandated by the ICS27 protocol.

### 5. ICS Version Compatibility:

The program operates under the `svm/borsh-1` ICS version, ensuring compatibility with the serialization and deserialization standards.
Where `borsch` is encoding, `svm` is transaction type and `1` is version of implementation. 

### 6. Acknowledgment Handling:

Post-execution, the program communicates with the IBC core program, conveying an ACK (acknowledgment) or FAIL status to indicate the outcome of the transaction.

### 7. IBC Core Program Coordination:

The IBC core program is responsible for updating the packet's status based on the received acknowledgment. It manages TIMEOUT scenarios and verifies the port-caller program mapping, ensuring proper transaction flow and integrity.

## Extensions of initial implementation:

The first version of the program will not include:
- The capability to query the state of other packets, such as ICS20, ICS721, and ICS27 packets, by sequence ID, a feature commonly utilized in cosmos-ibc and by contracts in Osmosis WASM hooks protocols and CVM on Cosmos-CW.
- ALTs for compressing account information in transactions involving multiple accounts. Future versions may explore packet instructions for creating/extending LUTs or creating ALTs through ICS27 owner/IBC core governance/CVM owner initiatives for reuse in any packets later.

Said that CVM is no operation without implementing both, and heavy rely on IBC relayer and IBC core impementation to support above flows and enabling CVM.

This specification delineates the functional blueprint for a program enabling cross-chain transactions via the ICS27 protocol, specifying the workflow, requirements, and current limitations while acknowledging potential areas for future development.

## How it will be operate with ICS20 funds?

User will send ICS20 funds to his account abstraction.
After ICS20 assets received, ICS27 will be invoked. 
ICS27 will fail if ICS20 packet was not received before.
Funds always owned by user.

We avoid all issues of:

- https://github.com/osmosis-labs/osmosis/blob/main/cosmwasm/contracts/crosschain-swaps/README.md#error-handling
and (funds stuck, no incetives to do callbacks for handling callbacks, neither forward inceties) 
- https://github.com/cosmos/ibc-apps/tree/main/modules/ibc-hooks (needs 4 blocks to execute, not 2)

## Anchor usage

Anchor will not be used to implement contract processor and instructions. 
All logs which to be considered events generated by contract will be in Anchor format.

## ALT reuse

Seems not possible https://docs.solanalabs.com/proposals/versioned-transactions#lookup-table-re-initialization , so LUT to be always part of IBC packet, making it huge. At least not optimal variant. Futher research will be needed.

## References 

- https://docs.solanalabs.com/proposals/versioned-transactions#other-proposals
- https://github.com/cosmos/ibc/blob/main/spec/app/ics-027-interchain-accounts/README.md
- Search LUT and ICS27 usage and implementations
 
